这个项目进行部分修改，源码可以到https://github.com/NotMorven/megaface-evaluation.pytorch中获取。

修改部分主要是为了匹配config和简单运行，如今版本只需要修改config即可测试不同模型。

发的压缩包中包含了所有代码，数据集需要自行下载，存放位置放在和IJB同样的位置，Data\test中。

首先需要说明，megaface的运行逻辑是

​	1、读取模型和模型参数来生成特征，

​	2、用生成的特征来进行测试。

### 生成特征

运行步骤按照代码中的runwin.bat进行：

**首先运行 python gen_megaface.py**

**然后运行 python remove_noises.py**

前者是生成原始特征，后者是ArcFace专门进行清洗所写的代码。

### 测试

需要进入linux环境，建议采用虚拟机，启用共享文件夹选择代码所在的文件夹即可，这样方便些。

然后按照readme中按照opencv2.4（必须是2.4.x,因为megaface的程序强制要求）

**然后运行bash run.sh**



## 修改配置

### config修改

可以参考configs中的megaface进行修改。

其中，output同样是输出生成特征的位置，也是测试时读取特征的位置。

out_root是输出测试结果的位置。

### devkit/experiments/run_experiment.py修改

44行，默认参数设置，sizes代表distractors个数，大部分问题中均设置成1M，也就是1000000，已经在run.sh中默认是1000000.probe_list是一个读取列表，这里可能会有相对路径出错的问题，可以自行设置成绝对路径试一试（直接修改默认值就行了，不用在命令行里单独写，那样也可能出问题）

### 命令行修改

主要是改config路径，用--config就行

## 一些tip

#### 为什么要分win和linux？

单纯为了方便，正常大家python环境都设置在win下的，生成特征这种重任务咋win下合适些，不用到虚拟机中还下载torch去配置它，不过还是要为了测试下载一些专门的包的。

除非本来就是用linux就可以无视一切，只用linux。

#### 会不会一次就跑成功？

不知道，那两个megaface提供的exe程序不好搞，可能存在bash和sh的问题，可能存在路径绝对路径或者相对路径的问题，可能python版本问题（我是2.7），可能opencv安装版本不对，版本对了但安装不正确（我是源码安装的），可能安装了没启动opencv等等问题。

最有可能发生的就是，前面跑通了，最后却没有生成cmc和match两个join文件，那恭喜你，就差一步了，那就是反复跑，直到跑出来为止，因为没有生成意味着程序莫名中止了，可能是内存爆了什么的原因。

当然反复跑也有讲究的，我写了个run_experimentc和runc，它们和run_experiment和run没多大区别，就是把没跑通的部分反复跑。

然后就是建议在终端界面跑，在code的终端更容易跑失败。

如果终端跑也失败了，可以关掉终端再打开再跑。

如果还不行，那整个虚拟机重启。

这些问题是我主要遇到的，可能还有其他问题会出现。不过可能是我做法有问题，如果有更好的操作方法可以补充，然后我加以改进。

